# Xcluster/ovl - k0s

The [K0s](https://k0sproject.io/) Kubernetes installed on `xcluster`

## Single node (airgap) install

As in the [Quick Start Guide](
https://docs.k0sproject.io/stable/install/#quick-start-guide), but k0s
and the airgap bundle are already loaded in `/root/www`, and no `sudo`
is required.

Howto create an airgap bundle is [described](
https://docs.k0sproject.io/stable/airgap-install/), but I couldn't
find how to use it. The only clue seem to be this:

> Note: During the worker start up k0s imports all bundles from the $K0S_DATA_DIR/images before starting kubelet

`$K0S_DATA_DIR` defaults to `/var/lib/k0s`.

```
./k0s.sh test --nvm=1 start_empty
# On vm-201
ip ro delete default
tcpdump -ni eth1
# On vm-001
ln /root/www/k0s-$__k0sver-amd64 /bin/k0s
#k0s sysinfo
export K0S_DATA_DIR=/var/lib/k0s
mkdir -p $K0S_DATA_DIR/images
ln /root/www/k0s-airgap-bundle-$__k0sver-amd64 $K0S_DATA_DIR/images

k0s install controller --single
rc-status --servicelist
k0s start
k0s kubectl get nodes
k0s kubectl get pods -A
```

To test this automatically do:
```
./k0s.sh test single
```

## Install with k0sctl

The `k0sctl.yaml` file is generated by `./tar` but uses `$__k0sver`
that must be exported.  `$KUBECONFIG` must be unset since it confuses
`k0s kubectl`. "test start" (instead of "test start_empty") creates
the k0s-link and installs the airgap-bundle. It also deletes the
external route, so it's really an *airgap*.


```
./k0s.sh test start
# On vm-001
less k0sctl.yaml
export __k0sver
unset KUBECONFIG
k0sctl apply --disable-telemetry -c k0sctl.yaml
k0s kubectl get nodes
k0s kubectl get pods -A
```

To test this automatically do:
```
./k0s.sh test k0sctl
```

Create a base config:
```
k0sctl init --k0s --user root --key-path="/root/.ssh/id_dropbear_ssh" \
 192.168.1.1 192.168.1.2 > k0sctl-base.yaml
```

## Dual-stack and private registry

```
./k0s.sh test start_k8s
# On vm-001
less k0sctl-k0s.yaml
kubectl get pods -A
```

This installs a `k0s` cluster with `Calico` CNI-plugin in dual-stack
mode, and uses the private registry.

We must [configure containerd](
https://docs.k0sproject.io/stable/runtime/) to use the private registry
registry (http instead of https). The extra config is generated in
`/etc/k0s/containerd.d/private-reg.toml`.


## Upgrade

To test [upgrade of `k0s`](https://docs.k0sproject.io/stable/upgrade/)
you must specify `--k0sver_next`, which is the version to upgrade to.

```
./k0s.sh test --k0sver=v1.29.6+k0s.0 --k0sver_next=v1.30.2+k0s.0 start_k8s
```
This will preload both versions (still airgap).

Export the variables used in `k0sctl-k0s.yaml`, and apply the new
configuration.

```
export __k0sver=v1.30.2+k0s.0
export PREFIX
k0sctl apply -c k0sctl-k0s.yaml
# (system upgrades...)
```

The `/bin/k0s` still points to the old version. We created is
ourselves, so we have to upgrade it ourselves.
```
rm /bin/k0s
ln /root/www/k0s-$__k0sver-amd64 /bin/k0s
k0s version
k0s kubectl version
```
